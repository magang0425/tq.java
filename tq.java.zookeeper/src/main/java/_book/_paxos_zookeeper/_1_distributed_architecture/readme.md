2019-04-12

## 分布式架构


### 分布式的特点
1. 分布性
    - 在空间上随意分布
    - 分布情况随时变动
2. 对等性
    - 分布式系统中的**计算机没有主从之分**
    - 既没有控制整个系统的主机
    - 也没有被控制的从机, 
    - 组成分布式系统的所有计算机节点都是对等的
3. 并发性
    - 准确并高效的协调分布式并发操作
4. 缺乏全局时钟
    - 很难定义事件的先后顺序
5. 故障总会发生


### 分布式环境的各种问题
1. 通信异常
    - 通信时延造成的消息丢失以及消息时延
2. 网络分区
    - 各节点之间的网络时延不断增大, 导致部分节点之间无法正常通信, -- 网络分区(脑裂)
    - 出现局部小集群
3. 三态
    - 失败, 超时, 成功
    - 超时
        - 发送超时
        - 发送之后, 获取响应超时
4. 节点故障


### 从ACID 到 CAP/BASE
1. ACID
    - 原子, 隔离, 一致, 持久
2. 分布式事务
    - 事务的参与者, 支持事务的服务器, 资源服务器, 事务管理器, 分别位于分布式系统的不同节点上
3. CAP理论和 BASE 理论
    - 可用性和一致性无法存在一个两全其美的方案
        - 要想实现可用性, 就必须采用多节点, 冗余部署
        - 但是这就是给数据带来 一段时间的数据不一致
    - CAP
        - Consistency
            - 数据在多个副本之间是否能够保持一致的特性
        - Availability
            - 系统提供的服务必须一直处于可用的状态, 对于每个用户的操作请求总是能够在**有限时间内返回结果**
        - Partition tolerance
            - 分布式系统在遇到任何网络分区故障的时候, 仍然需要能够保证对外提供满足一致性和可用性的服务
        - 选择
            - 放弃P
                - 所有数据放在一个分布式节点
                - 同时放弃了系统的可扩展性
            - 放弃A
                - 一旦系统出现故障, 服务将无法对外提供正常的服务
            - 放弃C
                - 不是完全不需要数据一致性, 那将使整个系统没有价值
                - 放弃强一致性, 而保留数据的最终一致性
                - 时间窗口
        - 结论
            - 对于分布式系统来说, 分区容错性是一个基本的需求, 
                - 既然是一个分布式系统, 分布式系统中的组件必然会被部署到不同的节点, 
                - 必然出现子网络
                - 网络问题又是一个必然会出现的问题, 
                - 因此分区容错性也就成为一个分布式系统必然要面对和解决的问题
            - 如何 根据业务特点在 C 和 A 之间寻求平衡
    - BASE 理论
        - [](../../../../../../../tq.java.distributed.system/src/main/java/_me_online/_transaction/_distributed_transaction/readme.md)
        - 基本可用
            - 响应时间上损失: 比如增加响应时间
            - 功能上的损失: 降级, 限流
        - 软状态
            - 允许数据存在中间状态, 
            - 允许系统在不同节点的数据副本之间进行数据同步的过程存在延时
        - 最终一致性
            - 系统中的所有数据副本, 在经过一段时间的同步后, 最终达到一个一致的状态
4. 最终一致性的五类主要变种
    - 因果一致性
        - A进程 通知 B 更新数据, B 就是最新的值, 如果 B 进行更新操作, 必须基于A 更新后的值
        - C 进程 与 A无关, 没有这个限制
    - 读己之所写
    - 会话一致性
    - 单调读一致性
        - 从系统中读取一个数据项的某个值之后, 那么该系统在之后的读取中, 不应该返回更旧的值
    - 单调写一致性
                