2018-05-08

## 复制

### 建立复制
1. 一个从节点只能有一个主节点
2. 一个主节点可以同时具有多个从节点
3. 复制的节点是单向的 主-->从
4. **从节点配置 slaveof masterHost masterPort**


### 断开复制
1. slaveof no one
    - 断开与主节点的复制关系
    - 从节点晋升为 主节点
2. 切换主节点-- slaveof newHost newPort
    - 断开与旧主节点的复制关系
    - 与新节点建立复制关系
    - **删除从节点的当前所有数据**
    - 最新主节点进行复制操作
3. Q:
    - **如果当前节点就是主节点, 如果成为从节点是否删除当前数据**
    - **是的**

### 传输延时
1. 主从节点一般部署在不同机器上， 复制时的网络延迟就成为需要考虑的
   问题， Redis为我们提供了repl-disable-tcp-nodelay参数用于控制是否关闭
   TCP_NODELAY， 默认关闭
   - 当关闭时， 主节点产生的命令数据无论大小都会及时地发送给从节
     点， 这样主从之间延迟会变小， 但增加了网络带宽的消耗。 适用于主从之间
     的网络环境良好的场景， 如同机架或同机房部署
   - 当开启时， 主节点会合并较小的TCP数据包从而节省带宽。 默认发送
     时间间隔取决于Linux的内核， 一般默认为40毫秒。 这种配置节省了带宽但
     增大主从之间的延迟。 适用于主从网络环境复杂或带宽紧张的场景， 如跨机
     房部署
2. 部署主从节点时需要考虑网络延迟、 带宽使用率、 防灾级别等因素， 如
   要求低延迟时， 建议同机架或同机房部署并关闭repl-disable-tcp-nodelay； 如
   果考虑高容灾性， 可以同城跨机房部署并开启repl-disable-tcp-nodelay
   
### 拓扑
1. 一主一从
    - 当应用写命令并发量较高且需要持久化时， 可以只在从节点上开启AOF
    - **当主节点关闭持久化功能时，
      如果主节点脱机要避免自动重启操作。 因为主节点之前没有开启持久化功能
      自动重启后数据集为空， 这时从节点如果继续复制主节点会导致从节点数据
      也被清空的情况， 丧失了持久化的意义**
    - 安全做法: 从节点 slaveof on one
2. 一主多从
    - 读写分离
    - 读命令发送到从节点执行
    - 缺点:
        - 高并发的时候, 多个从节点导致主节点的写命令多次发送, 消耗带宽
        - 加重 主节点的不稳定性
3. 树状主从结构
    - 从节点作为其他节点的主节点, 继续向下层复制
    - 降低对主节点的干扰
    
    
### 原理
1. 
     
    