2018-05-08

## 问题

### 读写分离
1. 因为读写分离, 主节点只负责写, 从节点只负责读, 就会造成
    - 复制数据延迟
        - 延迟无法避免, 取决于网络带宽以及命令阻塞情况
        - 解决:
            - 可以编写外部监控程序, 监听主从节点的复制偏移量, 当延迟较大的时候发送报警或者通知客户端避免读取延迟高的从节点
    - 读到过期数据
        - 如果数据大量超时, 主节点的采样速度更不上过期速度, 而且主节点没有读取过期键的操作,那么从节点无法收到del命令, 这是从可以读取到过期数据
        - **Redis在 3.2 版本修复了这个问题--从节点读取数据之前检查键的过期时间来决定是否返回数据**
    - 从节点故障
    
### redis删除过期数据策略
1. 惰性删除
    - 每次处理读取命令时, 检查键是否超时, 超时执行del, 然后一步发送del到从结点
    - 为了保持复制的一致性, 从节点自身永远不会主动删除过期数据
2. 定时删除
    - 定时任务, 循环采样, 删除过期键, 同步从节点
    
### 主从复制不一致
1. maxmemory: 当从节点小于主节点, 会触发 从节点根据 maxmemory-policy策略进行内存溢出控制 
2. 此时, 从节点的数据已经丢失, 主从复制已让进行, 复制偏移量也正常, 只能去做全量复制来修复问题

### 规避全量复制


### 复制风暴
1. 单主节点复制风暴
    - 一个主节点挂载多个从节点
    - 减少主节点挂载的从节点数量
    - 树状结构
    - 加入中间层节点保护主节点
2. 单机器复制风暴
    - 单台机器多个主节点
    
### 自己 
1. //TODO 自己测试的过程中, 从节点没有触发部分复制???
