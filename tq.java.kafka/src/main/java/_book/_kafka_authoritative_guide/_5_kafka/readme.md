2019-01-20

## 深入 Kafka

### 集群成员的关系
1. 使用 zookeeper 来维护集群成员的关系
    - 每一个 broker 有一个唯一的标识符
2. /brokers/ids
3. 在 broker 停机, 出现网络分区, 长时间的垃圾回收停顿
    - broker 会从 Zookeeper 上断开连接, 

### 控制器
1. 就是一个 broker
    - 除了负责一般 broker 的功能之外, **还负责分区首领的选举**
2. 步骤
    - 集群中第一个启动的broker 在 Zookeeper 中创建一个临时节点 /controller 让自己成为控制器
    - 其他节点 在控制器上创建 Zookeeper watch 对象, 收到节点变更的通知
    - 收到节点变更的通知, 会有一个新的先启动的 broker 成为新的 控制器
    - 新的 控制器通过 Zookeeper 的条件递增操作获取一个全新的, 数值更大的 controller epoch, 
    - 其他broker 知道当前的 controller epoch 之后, 如果控制器发出的包含旧的 epoch, 忽略
3. 使用 epoch 来避免 脑裂


### 复制
1. Kafka 使用主题来组织数据, 每个主题被分为若干个分区, 每个分区有多个副本
2. 副本的类型
    - 首领副本
        - 每一个分区都有一个首领副本, 
        - **保持一致性, 所有生产者和消费者的请求都会经过这个副本**
    - 跟随者副本
        - **首领之外的副本**
        - 跟随者副本不处理来自客户端的请求, 唯一任务是从首领哪里复制消息, 保持与首领的一致性
3. 首领的另外一个任务--搞清楚哪个追随者的状态和自己是一致的