2018-12-06

## TCP的连接与关闭

### 建立连接


### 连接建立的超时

### MSS
1. TCP 发送到另一端的最大块数据的长度
2. 可以不一样
3. 建立连接的时候通告它所期望的 MSS 选项
3. 大小
    - 对于以太网 1460(1500-20tcp-20ip)
4. 不同网络
    - **如果中间网络采用了更小的 MTU, 也会出现分段**
    - **MTU发现机制解决**

### TCP半关闭
1. TCP 提供了连接的一端在结束它的发送后还能接收来自另一端数据的能力
2. shutdown

### TCP状态
![](1.jpg)

### 2MSL等待状态
1. MSL
    - Maximum Segment Lifetime 报文最大生存时间
    - 超过这个时间的报文将被丢弃 
    - RFC793 规定为 2min, 实际中使用 30s, 1min, 2min
2. TTL
3. 2MSL
    - 两倍的MSL
4. TCP--TIME_WAIT
    - 2MSL等待状态
    - 过程
        - 当TCP的一端发起主动关闭，在发出最后一个ACK包后，即第3次握手完成后发送了第四次握手的ACK包后就进入了TIME_WAIT状态，
        - 必须在此状态上停留两倍的MSL时间，
        - **等待2MSL时间主要目的是怕最后一个ACK包对方没收到，那么对方在超时后将重发第三次握手的FIN包**，
        - 主动关闭端接到重发的FIN包后可以再发一个ACK应答包。
        - **在TIME_WAIT状态时两端的端口不能使用，要等到2MSL时间结束才可继续使用**。
        - 当连接处于2MSL等待阶段时任何迟到的报文段都将被丢弃。
        - 不过在实际应用中可以通过设置SO_REUSEADDR选项达到不必等待2MSL时间结束再使用此端口。

### 平静时间
1. RFC 793指出TCP在重启动后的MSL秒内不能建立任何连接

### 
