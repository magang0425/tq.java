2019-01-10

## 演变

### 单机的交易网
1. 单机负载告警, 数据库和应用分离
2. 服务器走向集群, 前端负载均衡器
    - Session 问题
        - 通过负载均衡器之后, 用户 Session 可能被路由到不同的机器上
    - 解决
        - 1
            - 方案
                - Session Sticky
                - 保证同一个会话的请求在同一个Web服务器上处理
                - 需要负载均衡器能够根据每次请求的回话标识来进行请求转发
            - 问题
                - 如果有一台web服务器宕机或者重启, 这台机器上的会话数据就会丢失
                - 会话标识是 应用层的 信息, 需要进行第七层 解析
                - 负载均衡器将变为一个 有状态的 节点, 内存消耗更大, 容灾方面更麻烦
        - 2
            - 方案
                - Session Replication
                - web服务器之间增加会话数据的同步
            - 问题
                - 同步 Session 数据造成网络带宽的开销, 
                - 每台服务器都要保存所有的 Session 数据, 如果集群的Session数量很多, 每台机器用于保存 Session 数据的内容
                    会很严重
            - 适用
                - 集群数量不多的情况
        - 3
            - 方案
                - Session 数据集中缓存 
                - Session 的修改都会在集中缓存中
            - 问题
                - 读写Session数据引入网络操作, 存在时延和不稳定
                    - 通信尽量发生在内网
                - 集中缓存发生故障, 影响应用
        - 4 
            - 方案
                - Cookie Based
                - Session数据放在 Cookie 里, 在web服务器上从Cookie中生成对应的 Session数据, 
            - 问题
                - Cookie 长度的限制
                - 安全性
                - 带宽消耗
                - 性能影响
    - 数据库读写分离
        - 问题
            - 数据复制问题
                - 数据复制时延 带来的短期数据不一致的问题
            - 应用对于数据源的选择问题
                - 应用根据不同的情况选择不同的数据源
                    - 写, 事务 走主库
                - 只是增加可以个可以读取数据的 '源', 至于 '源' 来自那里, 数据库, 应用都可以
        - 搜索引擎其实就是一个读库
            - 读 源
            - 根据被搜索的数据来构建索引
            - 构建索引的方式
                - 全量/增量划分
                - 实时/非实时划分
    - 缓存
        - 热数据 而不是 全部数据
        - 数据不存在, 查询数据库 然后放入缓存
        - 缓存容量不足, 最近不被访问的数据被清除
        - 数据更新, 同步缓存(全量缓存)
    - 分布式存储系统
        - 多数情况下 直接代替了主库
        - 三个常见
            - 分布式文件系统
                - 解决 小文件 和 大文件的存储问题
            - Key-value
                - 提供高性能的半结构化支持
            - 分布式数据库
                - 支持大数据, 高并发的数据库系统
    - 数据库拆分
        - 垂直拆分
            - 不同的业务数据拆分到不同的数据库中
            - 影响
                - 应用配置多个数据源
                - 分布式事务
        - 水平拆分
            -  同一个表的数据拆到两个数据库中
            - 问题
                - 需要解决 SQL 路由问题
        - 读写分离 vs 水平拆分 vs 垂直拆分
            - 数据读写分离是解决的读压力大的问题, 对于数据量较大或者更新量较大的情况下不起作用
            - 垂直拆分 是把不同的表拆分到不同的数据库, 水平拆分 是把同一个表拆到不同的数据库中
    - 应用拆分
        - 分模块拆分不同系统
        - 服务器化