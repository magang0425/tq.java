2019-02-26

## 事务

### 认识事务
1. ACID
2. 分类
    - 扁平事务
        - 回滚到起始点
        - 代价较大
    - 带有保存点的扁平事务
        - 允许事务执行过程中回滚到事务中较早的一个状态
    - 链事务
        - 保存点模式的变种
        - 下一个事务可以看到上一个事务的结果, 
        - 回滚只限于 当前事务, 只能恢复到最近的一个保存点
        - 
    - 嵌套事务
        - 树
    - 分布式事务
        - 分布式环境下的运行的扁平事务

### 事务的实现
1. 隔离性--锁
2. 原子性, 一致性, 持久性-- redo log + undo log
3. redo 
    - 持久性
    - 两部分
        - 重做日志缓冲(redo log buffer)
        - 重做日志文件(redo log file)
4. TODO

### 事务的实现(https://draveness.me/mysql-transaction)
1. 事务其实就是并发控制的基本单位
2. 数据库事务的 ACID 四大特性是事务的基础, ACID 是如何实现的，也就清楚了事务的实现
3. ACID的实现
    - 原子性
        - 回滚日志 undo log
            - 逻辑日志
            - 按照日志逻辑地将数据库中的修改撤销掉, 可以理解为 insert 对应 delete, update 对应 相反的 update
            
    - 持久性
        - 重做日志 redo log
            - 物理日志
            - 两部分
                - 重做日志缓冲(redo log buffer)
                - 重做日志文件(redo log file)
            - 数据修改过程
                - 数据从磁盘写入内存
                - 更新内存中的数据
                - 生成重做日志写入 重做日志缓冲
                - 事务真正提交前, 重做日志缓冲的内容刷新到重做日志文件
                - 提交日志
                - 内存中的数据 更新 到磁盘
            - **回滚日志也是需要持久存储的，它们也会创建对应的重做日志**，在发生错误后，
                数据库重启时会从重做日志中找出未被更新到数据库磁盘中的日志重新执行以满足事务的持久性。
    - 隔离性
        - 隔离级别
        - 实现
            - 锁
                - 共享锁
                - 互斥锁
            - 时间戳
                - CAS
            - 多版本和快照隔离
                - MVCC   
    - 一致性(https://www.zhihu.com/question/30272728/answer/72476703)
        - **原子性并不能够完全保证一致性**。
        - **一致性是最基本的属性**，其它的三个属性都为了保证一致性而存在的。
        - 为了实现原子性, 需要通过日志
            - **但是在 多个事务并发进行的情况下, 即使保证了每一个事务的原子性, 数据仍然可能不一致**
        - 为了解决并发情况下的一致性 --> 引入 隔离性
            - 悲观锁
            - 乐观锁