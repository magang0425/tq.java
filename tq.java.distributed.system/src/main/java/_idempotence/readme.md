2018-03-09

### 概述
1. 对同一个系统，使用同样的条件，一次请求和重复的多次请求对系统资源的影响是一致的。
2. 幂等有两个维度：一是空间维度上的幂等，即幂等对象的范围，是个人还是机构，是某一次交易还是某种类型的交易...
二是时间维度上的幂等，即幂等的保证时间，是几秒、几分钟还是永久性的.

### 幂等的常用思路

#### 去重表(唯一索引)
1. 利用数据库表单的特性来实现幂等，常用的一个思路是在表上构建唯一性索引，保证某一类数据一旦执行完毕，后续同样的请求再也无法成功写入

#### TOKEN机制
1. 为每一次操作生成一个唯一性的凭证，也就是token。一个token在操作的每一个阶段只有一次执行权，
一旦执行成功则保存执行结果。对重复的请求，返回同一个结果
2. 记录操作状态, 
3. 保证操作顺序的话, 需要队列支持 

#### 悲观锁
1. 关键字为主键或者是 唯一索引, 伴随事务一起使用
2. select * from table_xxx where id='xxx' for update

#### 乐观锁
1. MVCC
    - 多版本并发控制，乐观锁的一种实现，在数据更新时需要去比较持有数据的版本号，版本号不一致的操作无法成功
    - update blogTable set count= count+1,version=version+1 where id=321 and version=123 
    - 每一个version只有一次执行成功的机会，一旦失败必须重新获取。
2. 状态条件(**状态机幂等**)
    - update table_xxx set avai_amount=avai_amount-#subAmount# where avai_amount-#subAmount# >= 0 and status < xx
    - 这个情景适合不用版本号，只更新是做数据安全校验，适合库存模型，扣份额和回滚份额，性能更高；

#### 分布式锁


#### select + insert
1. 并发度不高, 先查在更新

#### 对外提供接口的api如何保证幂等
1. source来源，seq序列号；source+seq在数据库里面做唯一索引，防止多次付款(并发时，只能处理一个请求) 。
2. 对外提供接口为了支持幂等调用，接口有两个字段必须传，一个是来源source，一个是来源方序列号seq，
3. 这个两个字段在提供方系统里面做联合唯一索引，这样当第三方调用时，先在本方系统里面查询一下，是否已经处理过，返回相应处理结果；
4. 没有处理过，进行相应处理，返回结果。
5. 注意，为了幂等友好，一定要先查询一下，是否处理过该笔业务，不查询直接插入业务系统，会报错，但实际已经处理了。

