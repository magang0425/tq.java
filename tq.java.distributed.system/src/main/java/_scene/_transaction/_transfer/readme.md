2018-12-14

## 2个数据库转账问题

### https://www.jianshu.com/p/21a537d6e397
1. 设计
    - 接口规范：入参校验等；
    - 安全：采用加密token保证接口安全(15年发现每日生鲜在调用支付宝付款时可以拦截修改参数，觉得不可思议，
    -  后来发现不止每日生鲜，包括很多校园零售App，生鲜App)；
    - 幂等：插入转账记录表，使用唯一约束保证幂等；
    - 重试：幂等可以防重；
    - 并发：使用 乐观锁 + 事务；
    - 异常分支：
        - 安全性校验不通过；
        - 参数校验不通过；
        - 重试不通过；
        - 余额不足；
        - 扣款、付款失败。
    - 事务一致性：在转账记录表中增加状态（status）字段值，1表示扣款成功，2表示付款成功；
    -  转账和付款在两个事务，付款操作更新状态为1的记录；如果扣款失败，启动定时任务进行扫描状态为1的记录进行付款；
    - 用户投诉：各阶段异常分支，可以用枚举返回（未实现），用于反馈；
    - 资金安全：先扣款，再付款，保证资金安全；
    - 接口名称：service.TransferAccountsService
2. 思考
    - 启动一个Timer不停重试扣款成功但是加钱失败的操作
    - update xxx set account=account-x where id=id and ver=ver and acc=acc;